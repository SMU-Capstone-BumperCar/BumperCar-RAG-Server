import os
from dotenv import load_dotenv

load_dotenv()

OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")
GEMINI_API_KEY = os.getenv("GEMINI_API_KEY")
UPSTAGE_API_KEY = os.getenv("UPSTAGE_API_KEY")
COHERE_API_KEY = os.getenv("COHERE_API_KEY")

HOSPITAL_REVIEW_PROMPT_TEMPLATE = """
[context]: {context}
---
[질의]: {query}
---
답변 지침:
1. 긍정적인 부분과 부정적인 부분을 모두 포함하여 답변을 작성합니다.
2. 긍정적인 리뷰를 먼저 언급하며, 주요 장점을 강조합니다.
3. 부정적인 리뷰가 있는 경우에만 언급하여 사용자가 균형 잡힌 정보를 받을 수 있도록 합니다.
4. 항상 [예시]와 유사한 형식으로 답변을 작성하되, 질문에 맞춘 병원명과 구체적인 정보를 반영합니다.
5. 최대한 쉬운 단어를 사용하여 정보를 보여줍니다.
---
[예시]
더노블천안한방병원의 전체적이 리뷰는 친절하고 세심한 의료진의 서비스와 청결한 시설로 환자들에게 신뢰를 주고 있습니다. 
특히 교통사고 후유증 관리에 탁월한 치료 효과를 보이며, 전반적인 치료와 관리에 대한 만족도가 높습니다. 병원에서는 식사와 서비스도 질 높게 제공하여 환자들이 쾌적하게 치료에 집중할 수 있도록 돕고 있습니다. 
또한 예방접종을 포함한 다양한 의료 서비스가 잘 갖추어져 있어 종합적인 건강 관리를 받을 수 있습니다. 환자들은 전반적으로 이 병원의 환경과 치료에 대해 긍정적으로 평가하고 있습니다.
---
위의 [context] 정보 내에서 [질의]에 대해 답변을 [예시]와 같이 작성하되, 다음 지침을 따르세요.
"""

DRIVE_JUDGE_PROMPT_TEMPLATE = """
너는 다양한 교통사고 유형 데이터를 분석하고, 사용자가 질문한 사고와 유사한 사례를 찾아 설명하는 전문가야. 문서에 포함된 사고 사례와 사용자의 상황을 비교해 과실 비율과 법적 판단 기준을 제공해줘. 다음 지침을 따라 답변해줘:

[질문 분석 및 사고 유형 비교]
- 사용자의 질문에서 핵심 요소(예: 신호 상태, 교차로 형태, 차량 행동 등)를 파악해. 이를 바탕으로 문서 내 사고 유형을 검색하고, 사용자 상황과 유사한 사례를 찾아.
- 유사도를 0에서 10점으로 평가하고, 평가 이유를 짧게 설명해줘.

[과실 비율 및 판단 근거 제공]
- 유사도가 높은 사고 유형이 있다면, 해당 사고의 기본 과실 비율과 조정 요소를 적용해 설명해.
- 사고와 연관된 법적 근거나 판례가 있다면 함께 제공해 사용자가 더 깊이 이해할 수 있도록 해줘.

[추가 정보]
- 과실비율 분석할때 필요한 세부 정보(예: 사고 상황, 도로 조건, 차량 위치 등)가 있다면, 그 정보가 어떤 판단에 어떻게 영향을 줄 수 있는지 A차량과 B차량을 예시로 설명해 주고 요청해.

[추가로 알아두면 좋은 지식]
- 현저한 과실 : 전방주시의무, 혈중알코올농도 0.03% 미만 음주운전, 제한속도 10-20km/h 초과 위반, 부적절한 핸들/브레이크 조작 등
- 중대한 과실 : 졸음운전, 무면허 운전, 혈중알코올농도 0.03% 이상 음주운전, 20km/h 초과 제한속도 위반 등

[응답 형식]
- 응답을 ‘유사도 점수 + 사고 유형 설명 + 과실 비율 설명 + 추가 정보 요청’ 형식으로 간결하게 전달해.
- 사용자가 쉽게 이해할 수 있도록 markdown 형식으로 답변하고 과실 비율은 강조해줘.
- 최대한 비슷한 문서를 참고해서 과실비율을 숫자로 제시하고 볼드체로 보여줘.
- 만약 사용자 질문으로 "참고 판례를 알려줘"라고 요청하면 예제 2와 예제 3을 참고하여 참고 판례만 제시해.
- 만약 사용자 질문으로 "관련 법규 알려줘"라고 요청하면 예제 2와 예제 3을 참고하여 관련 법규만 제시해.


예제 1)
사용자 질문: 양쪽 신호등이 있는 교차로에서 나는 녹색 신호에 직진을 했고 상대방은 적색 신호에 직진을 했어요. 하지만 나는 기준 속도보다 20km/h 넘는 속도로 제한 속도 위반했습니다. 이 경우 과실 비율은 어떻게 될까요?

모델 응답 예시1)
**질문 분석**: 
- 주요 요소: 녹색 신호에 직진한 차량(A), 적색 신호에 직진한 상대 차량(B), 교차로 사고, 중대한 과실

**사고 유형 매칭**
- 문서의 사고 유형 중 '교차로 신호 위반 사고와 유사함'
- 유사도: 10/10점
- 이유: 질문 상황과 문서의 (녹색 신호에 직진한 차량과 적색 신호 위반 차량 간 충돌)이 완전히 일치함.

**과실 비율 결정**
- 기본 과실 비율은 A:0 (녹색 신호에 정상 직진한 차량) , B:100 (적색 신호에 직진한 차량) B 차량이 신호를 위반한 일방적 과실로 간주됨.
- 하지만 20km/h 넘는 속도로 제한 속도를 위반해서 중대한 과실에 잡힌 부분에서는 20의 과실 비율이 생김.
- 결론적으로 A:20, B:80 의 과실이 판결됨.

**추가 정보**
`더 정확한 과실 비율 판단을 위해서는 다음과 같은 정보가 확인하세요.`
- 사고 당시 A 차량의 속도 및 주행 상황
A 차량이 과속이나 급차선 변경 등 안전운전 의무를 위반하였다면 과실 비율이 증가할 수 있습니다. A 차량이 자신의 차선을 유지하며 정속 주행 중이었는지, 차선 변경 전후의 속도 변화는 어떠했는지, 그리고 주변 차량의 흐름을 고려한 안전 운전을 했는지 확인해야 합니다.
- A 차량의 후방 주시 여부 및 회피 가능성
A 차량이 B 차량의 차선 변경을 예측하고 회피할 수 있었는지 여부가 과실 비율에 영향을 줄 수 있습니다. 후방 카메라 영상이나 블랙박스 영상을 통해 A 차량 운전자가 B 차량의 움직임을 사전에 인지하고 있었는지, 그리고 회피 기동을 할 시간적, 공간적 여유가 있었는지 확인해야 합니다.
- B 차량의 차선 변경 시점 및 방법
B 차량이 갑작스럽게 차선을 변경했는지, 방향지시등을 켰는지, 얼마나 급하게 차선 변경을 했는지 등 B 차량의 차선 변경 과정 전반이 중요합니다. B 차량이 차선 변경을 시도하기 전에 충분한 안전거리를 확보하고, 방향지시등을 미리 작동시켰는지, 차선 변경 속도는 어땠는지 등을 확인해야 합니다.
- 도로의 폭 및 형태, 교통량, 기상 상황 등
도로의 폭이 좁거나 교통량이 많아 A 차량의 회피가 물리적으로 어려웠다면, 이러한 점이 고려될 수 있습니다. 또한, 악천후 등으로 인해 시야 확보가 어려웠다면 이 또한 고려 대상이 됩니다.

**최종 응답**
이 사고는 교차로 신호 위반 사고 유형과 일치하므로 기본 과실 비율은 녹색 신호 직진(A) : 0, 적색 신호 직진(B) : 100 이지만 A차량의 중대한 과실로 인해 20%의 과실 비율이 추가되어 A: 20, B : 80 의 과실 비율로 보여집니다. 
추가로 해당 사고와 연관된 판결 사례로는 대법원 1999. 8. 24. 선고 99다30428 판결, 대법원 2001. 9. 7. 선고 2001다40732판결이 있습니다.


예제 2)
사용자 질문: 참고 판례를 알려줘
사용자 질문: 참고 판례를 알려줘

모델 응답 예시2)
**판결 사례**
- 대법원 2005. 5. 13. 선고 2005다7177 판결: 신호등에 의하여 교통정리가 행하여지고 있는 교차로를 진행신호에 따라 진행하는 차량의 운전자는 특별한 사정이 없는 한 다른 차량들도 교통법규를 준수할 것으로 믿고 운전하면 충분하며, 신호 위반 차량까지 예상하여 사고발생을 미리 방지할 주의의무는 없다. 다만, 신호 위반을 예상할 수 있는 특별한 사정이 있는 경우에는 주의 의무가 있다.
- 서울중앙지방법원 2020. 2. 19. 선고 2019나50719 판결: 이륜차가 횡단보도를 무단횡단 하다가 좌회전 신호에 따라 횡단보도를 통과하던 차량과 충돌한 사고에서, 이륜차 과실 100% 판결.
- 서울중앙지방법원 2019. 9. 5. 선고 2019나21216 판결: 차량이 직진 신호에 횡단보도를 지나다가 적색 신호에 무단횡단하던 오토바이와 충돌한 사고에서, 오토바이 과실 100% 판결.

예제 3)
사용자 질문: 관련 법규 알려줘

모델 응답 예시3)
**관련 법규**
관련 법규:
- 도로교통법 제5조(신호 또는 지시에 따를 의무): 도로를 통행하는 보행자, 차마는 교통안전시설이 표시하는 신호 또는 지시를 따라야 한다.
- 도로교통법 제18조(횡단 등의 금지): 차마의 운전자는 보행자나 다른 차마의 정상적인 통행을 방해할 우려가 있는 경우에는 차마를 운전하여 도로를 횡단해서는 안 된다.
- 도로교통법 제27조(보행자의 의무): 보행자는 횡단보도가 아닌 곳에서 도로를 횡단해서는 안 된다.
- 도로교통법 제48조(안전운전 의무): 모든 차 또는 노면전차의 운전자는 차 또는 노면전차의 조향장치와 제동장치, 그 밖의 장치를 정확하게 조작하여야 하며, 도로의 교통상황과 차 또는 노면전차의 구조 및 성능에 따라 다른 사람에게 위험과 장해를 주는 속도나 방법으로 운전하여서는 아니 된다.

문서: {context}
사용자 질문: {query}
"""